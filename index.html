<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aiye - Loading Planetary Operating Room</title>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            overflow: hidden; 
            font-family: 'Courier New', monospace;
            background: #000;
            -webkit-text-size-adjust: 100%;
        }
        
        #bg-video {
            position: fixed;
            top: 50%;
            left: 50%;
            min-width: 100%;
            min-height: 100%;
            width: auto;
            height: auto;
            transform: translate(-50%, -50%);
            z-index: 0;
            object-fit: cover;
        }
        
        .loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .logo {
            font-size: clamp(40px, 12vw, 72px);
            color: #00FF88;
            margin-bottom: 15px;
            text-shadow: 0 0 30px rgba(0, 255, 136, 0.8);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.05); }
        }
        
        .title {
            font-size: clamp(24px, 8vw, 48px);
            color: #fff;
            margin-bottom: 8px;
            letter-spacing: 3px;
        }
        
        .subtitle {
            font-size: clamp(12px, 3.5vw, 18px);
            color: #2E8CE0;
            margin-bottom: 30px;
            letter-spacing: 1px;
            text-align: center;
        }
        
        .loading-container {
            width: 100%;
            max-width: 500px;
            padding: 0 20px;
        }
        
        .loading-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid #2E8CE0;
            box-shadow: 0 0 20px rgba(46, 140, 224, 0.5);
        }
        
        .loading-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #2E8CE0, #00FF88);
            border-radius: 10px;
            transition: width 0.3s ease;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.8);
        }
        
        .loading-text {
            text-align: center;
            color: #fff;
            margin-top: 15px;
            font-size: clamp(12px, 3.5vw, 16px);
            letter-spacing: 1px;
        }
        
        .loading-percentage {
            color: #00FF88;
            font-size: clamp(18px, 5vw, 24px);
            font-weight: bold;
            margin-top: 8px;
        }
        
        .status-text {
            color: #2E8CE0;
            font-size: clamp(11px, 3vw, 14px);
            margin-top: 8px;
            min-height: 18px;
        }
    </style>
</head>
<body>
    <video id="bg-video" autoplay muted loop playsinline>
        <source src="backvid.mp4" type="video/mp4">
    </video>
    
    <div class="loader-overlay">
        <div class="logo">üåç</div>
        <div class="title">AIYE</div>
        <div class="subtitle">Planetary Operating Room</div>
        
        <div class="loading-container">
            <div class="loading-bar">
                <div class="loading-fill" id="loading-fill"></div>
            </div>
            <div class="loading-text">
                <div class="loading-percentage" id="percentage">0%</div>
                <div class="status-text" id="status">Initializing systems...</div>
            </div>
        </div>
    </div>

    <script type="module">
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        const loader = new GLTFLoader();
        const fillBar = document.getElementById('loading-fill');
        const percentage = document.getElementById('percentage');
        const status = document.getElementById('status');
        
        let totalProgress = 0;
        const models = ['man.glb', 'lungs.glb', 'veins.glb'];
        const audio = ['keyboard.mp3'];
        const loadedModels = [];
        const loadedAudio = [];
        let videoLoaded = false;
        
        const statusMessages = [
            'Connecting to planetary sensors...',
            'Loading Amazon Lungs data...',
            'Mapping ocean circulation...',
            'Analyzing atmospheric conditions...',
            'Calibrating diagnostic systems...',
            'Preparing operating room...'
        ];
        
        let messageIndex = 0;
        const messageInterval = setInterval(() => {
            if (messageIndex < statusMessages.length) {
                status.textContent = statusMessages[messageIndex];
                messageIndex++;
            }
        }, 800);
        
        function updateProgress(progress) {
            fillBar.style.width = progress + '%';
            percentage.textContent = Math.round(progress) + '%';
        }
        
        async function loadVideo(url) {
            return new Promise((resolve) => {
                const videoElement = document.getElementById('bg-video');
                videoElement.addEventListener('loadeddata', () => {
                    videoLoaded = true;
                    resolve();
                }, { once: true });
            });
        }
        
        async function loadAudio(url) {
            return new Promise((resolve, reject) => {
                const audio = new Audio(url);
                audio.addEventListener('canplaythrough', () => {
                    loadedAudio.push(audio);
                    resolve();
                });
                audio.addEventListener('error', reject);
                audio.load();
            });
        }
        
        async function loadModel(url, index) {
            return new Promise((resolve, reject) => {
                loader.load(
                    url,
                    (gltf) => {
                        loadedModels.push(gltf);
                        const progress = ((index + 1) / models.length) * 100;
                        totalProgress = progress;
                        updateProgress(progress);
                        resolve();
                    },
                    (xhr) => {
                        const itemProgress = (xhr.loaded / xhr.total) * (100 / models.length);
                        const currentProgress = (index / models.length) * 100 + itemProgress;
                        updateProgress(currentProgress);
                    },
                    reject
                );
            });
        }
        
        async function loadAllModels() {
            try {
                // Load video first
                status.textContent = 'Loading background video...';
                await loadVideo('backvid.mp4');
                updateProgress(5);
                
                // Load audio
                status.textContent = 'Loading audio assets...';
                await loadAudio('keyboard.mp3');
                updateProgress(10);
                
                // Load 3D models
                for (let i = 0; i < models.length; i++) {
                    await loadModel(models[i], i);
                }
                
                clearInterval(messageInterval);
                status.textContent = 'Systems ready. Starting dialogue...';
                
                setTimeout(() => {
                    window.location.href = 'dialogue.html';
                }, 1500);
                
            } catch (error) {
                console.error('Loading error:', error);
                status.textContent = 'Error loading models. Retrying...';
                status.style.color = '#FF3300';
            }
        }
        
        // Ensure video plays
        const bgVideo = document.getElementById('bg-video');
        bgVideo.play().catch(e => console.log('Video autoplay prevented:', e));
        
        // Start loading
        loadAllModels();
    </script>
</body>
</html>
